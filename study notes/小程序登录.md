## 小程序授权登录

```
login() {
    // 登录
    wx.login({
      success: res => {
        // console.log(res)
        let code = res.code
        wx.authorize({
          scope: 'scope.userInfo',
          complete: res => {
            this.getUser(code)
          }
        })
      }
    })
  },
  getUser(code) {
    wx.getSetting({
      success: res => {
        if (res.authSetting['scope.userInfo']) {
          wx.getUserInfo({
            success: res => {
              this.globalData.userInfo = res.userInfo
              // console.log(res)
              wx.request({
                url: '',
                data: {
                  'code': code,
                  'encryptedData': res.encryptedData,
                  'iv': res.iv,
                  'istoken': 1
                },
                method: 'POST',
                header: {
                  'content-type': 'application/x-www-form-urlencoded'
                },
                dataType: 'json',
                success: res => {
                  // console.log(res.data)
                  // console.log(typeof JSON.parse(res.data.trim()))
                  let data = JSON.parse(res.data.trim())
                  // console.log(data)
                  if (data.errorCode === '1' && data.message === '登入成功') {
                    this.globalData.userData = data.data[0]
                    this.globalData.token = data.data[0].token
                    this.globalData.status = Number(data.data[0].status)
                    // wx.reLaunch({
                    //   url: '../../pages/index/index',
                    // })
                  } else if (data.errorCode === '5' && data.message === '未绑定账号') {
                    wx.setStorageSync('unionid', data.data.unionId)
                    wx.navigateTo({
                      url: '../../pages/login/login?unionid=' + data.data.unionId,
                    })
                  }
                  // console.log(this.globalData)
                }
              })
            }
          })
        } else {
          wx.openSetting({
            success: res => {
              wx.showModal({
                title: '提示',
                content: '请授权您的信息，并重新进入',
                showCancel: false,
                success: function (res) { }
              })
            }
          })
        }
      }
    })
  },
```
